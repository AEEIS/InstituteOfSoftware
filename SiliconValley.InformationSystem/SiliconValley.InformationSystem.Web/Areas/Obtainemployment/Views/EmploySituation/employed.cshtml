
@{
    Layout = null;
}

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>employed</title>
    <script src="~/Scripts/jquery-3.3.1.min.js"></script>
    <link href="~/Scripts/layui/css/layui.css" rel="stylesheet" />
    <script src="~/Scripts/layui/layui.js"></script>
    <link href="~/dleiicon/font_xhlb4bpyaza/iconfont.css" rel="stylesheet" />
    <style>
        .search {
            position: absolute;
            top: 13px;
            right: 10px;
            cursor: pointer;
        }

        
    </style>
</head>

<body>
    <div>
        <form class="layui-form" action="">
            <div class="layui-container">
                <div class="layui-row layui-form-item">
                    <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
                        <label class="layui-form-label lad">学生姓名:</label>
                        <div class="layui-input-inline">
                            <input type="text" id="StudentName" class="layui-input" readonly="readonly" style="border:none" />
                            <input type="text" name="StudentNO" id="StudentNO" class="layui-input" style="display:none" />
                        </div>
                    </div>

                    <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
                        <label class="layui-form-label lad">班级名称:</label>
                        <div class="layui-input-inline">
                            <input type="text" id="classno" class="layui-input" readonly="readonly" style="border:none" />

                        </div>
                    </div>
                </div>

                <div class="layui-row layui-form-item">
                    <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
                        <label class="layui-form-label lad">就业日期:</label>
                        <div class="layui-input-inline">
                            <input type="text" name="date" id="date" lay-verify="date" placeholder="yyyy-MM-dd" autocomplete="off" class="layui-input">
                        </div>
                    </div>
                </div>

                <div class="layui-row layui-form-item">
                    <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
                        <label class="layui-form-label lad">预想薪资:</label>
                        <div class="layui-input-inline">
                            <input type="text" id="Salary" class="layui-input" readonly="readonly" style="border:none" />
                        </div>
                    </div>

                    <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
                        <label class="layui-form-label lad">实际薪资:</label>
                        <div class="layui-input-inline">
                            <input type="text" name="RealWages" id="RealWages" class="layui-input" lay-verify="required" autofocus="autofocus" />
                        </div>
                    </div>
                </div>

                <div class="layui-row layui-form-item">
                    <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
                        <label class="layui-form-label lad">公司名称:</label>
                        <div class="layui-input-inline">
                            <input type="text" name="EntName" id="EntName" class="layui-input" lay-verify="required|EntNameZz|EntNameOnly" @*onblur="onblurfun()"*@ />
                            <span class="iconfont icon-search search"></span>
                        </div>
                    </div>

                    <div class="layui-col-xs6 layui-col-sm6 layui-col-md6 disappear">
                        <label class="layui-form-label lad">公司地址:</label>
                        <div class="layui-input-inline" id="EntAddressDiv">

                        </div>
                    </div>
                </div>
                <div class="layui-row layui-form-item disappear">
                    <div class="layui-col-xs12 layui-col-sm12 layui-col-md12">
                        <label class="layui-form-label">公司规模</label>
                        <div class="layui-input-block" id="EntScalediv">

                        </div>
                    </div>
                </div>
                <div class="layui-row layui-form-item disappear">
                    <div class="layui-col-xs12 layui-col-sm12 layui-col-md12">
                        <label class="layui-form-label">公司性质</label>
                        <div class="layui-input-block" id="EntNaturediv">
                        </div>
                    </div>
                </div>
                <div class="layui-row layui-form-item disappear">
                    <div class="layui-col-xs12 layui-col-sm12 layui-col-md12">
                        <label class="layui-form-label">公司所需要专业选择</label>
                        <div class="layui-input-block" id="Specialtydiv">

                        </div>
                    </div>

                </div>
                <div class="layui-row layui-form-item">
                    <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
                        <div class="layui-input-block">
                            <button type="button" class="layui-btn layui-btn-radius" lay-submit="" lay-filter="demo1">确定</button>
                        </div>
                    </div>
                    <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
                        <div class="layui-input-block">
                            <button type="button" class="layui-btn layui-btn-radius" id="signout">退出</button>
                        </div>
                    </div>
                </div>
            </div>

        </form>
    </div>
    <script src="~/Areas/Obtainemployment/Scripts/opneentxml.js"></script>
    <script src="~/Scripts/underscore.js"></script>
    <script type="text/template" id="muban1">
        <input type="radio" class="raddiobibi" name="EntScale" value="{{=text}}" title="{{=text}}" {{=checked}} {{=disabled}}>
    </script>
    <script type="text/template" id="muban2">
        <input type="radio" class="raddiolala" name="EntNature" value="{{=text}}" title="{{=text}}" {{=checked}} {{=disabled}}>
    </script>
    <script type="text/template" id="muban3">
        <input type="checkbox" class="duoduo" name="EntSpee" lay-filter="mycheckbox" value="{{=Id}}" title="{{=text}}" lay-skin="primary" {{=checked}} {{=disabled}}>
    </script>
    <script type="text/template" id="muban4">
        <input type="text" id="EntAddress" name="EntAddress" value="{{=text}}" class="layui-input" style="border:none" readonly="readonly" />
    </script>
    <script type="text/template" id="muban5">
        <input type="text" id="EntAddress" name="EntAddress" lay-verify="required" value="{{=text}}" class="layui-input" />
    </script>
    <script>
        var objdata;
        layui.use(['form', 'layedit', 'laydate'], function () {

            var laydate = layui.laydate;
            //日期
            laydate.render({
                elem: '#date'
            });
            var form = layui.form, layer = layui.layer;
            var info, EntScalearray, EntNaturearray, sepclist, entid = "", yes = false, jsenplist = new Array();
            jQuery(function () {
                info = JSON.parse('@Html.Raw(ViewBag.obj)');
                sepclist = JSON.parse('@Html.Raw(ViewBag.Sepclist)');
                $("#StudentName").val(info.StudentName);
                $("#classno").val(info.classno);
                $("#Salary").val(info.Salary);
                $("#StudentNO").val(info.StudentNO);
                EntScalearray = $getEntScales();
                EntNaturearray = $getEntNatures();
            });

            $(document).off("click", '.search').on('click', '.search', function () {
                console.log('11');
                loadentlist();
            });

            //失去焦点事件
            $(document).off("focusout", '#EntName').on('focusout', '#EntName', function () {
                //console.log('22');
                loadentlist();
            });

            function loadentlist(value) {
                var value = $("#EntName").val();
                value = value.replace(/\s*/g, '');
                if (value.length > 0) {
                    $.ajax({
                        url: '/Obtainemployment/EmploySituation/getentlist',
                        async: false,
                        data: { param0: value },
                        success: function (successdata) {
                            if (successdata.Success) {
                                if (successdata.Data.length > 0) {
                                    layer.open({
                                        type: 2,
                                        content: "/Obtainemployment/EmploySituation/entlist",
                                        title: "选择公司",
                                        area: ['680px', '350px'],
                                        success: function (layero, index) {
                                            let body = layui.layer.getChildFrame('body', index);
                                            body.find(".filename").val(JSON.stringify(successdata.Data));
                                        },
                                        end: function () {
                                            yes = true;
                                            entid = objdata.ID;
                                            loadEntAddress(true);
                                            loadEntScale(true);
                                            loadEntNature(true);
                                            loadsepclist(true);

                                        }
                                    });
                                } else {
                                    layer.msg('该公司无记录！', { icon: 6, time: 2000 }, function () {
                                        entid = "";
                                        yes = false;
                                        loadEntAddress(false);
                                        loadEntScale(false);
                                        loadEntNature(false);
                                        loadsepclist(false);

                                    });
                                }
                                form.render();

                            } else {
                                layer.msg(successdata.Msg, { icon: 6, time: 2000 }, function () {

                                });
                            }
                        },
                        error: function (errordata) {
                            layer.msg('网络不佳!', { icon: 6, time: 2000 }, function () {

                            });
                        }
                    });
                } else {
                    layer.msg('请输入公司名称！', { icon: 6, time: 2000 }, function () {
                    });
                }

            }
            //自定义验证规则
            form.verify({
                EntNameZz: [/^[\u4E00-\u9FA5A-Za-z]+$/, "不得输入数字，空格等特殊符号"]
                , EntNameOnly: function (value) {
                    var resultobj = new Object();
                    $.ajax({
                        type: "get",
                        url: "/Obtainemployment/EmploySituation/isonleyname",
                        async: false,
                        data: { param0: value, param1: entid },
                        success: function (data) {
                            console.log(data);
                            resultobj.isno = data.Success;
                            resultobj.mes = data.Msg;
                        },
                        error: function () {
                        }
                    });

                    if (!resultobj.isno) {
                        return resultobj.mes;
                    }

                }

            });
            ///加载公司规模
            function loadEntScale(iscun) {
                $("#EntScalediv").children().remove();
                console.log(EntScalearray);
                for (var i = 0; i < EntScalearray.length; i++) {
                    var obj = _.template($("#muban1").html());
                    var html = "";
                    if (iscun) {
                        if (EntScalearray[i].val == objdata.EntScale) {
                            html = obj({ text: EntScalearray[i].val, checked: "checked", disabled: '' });
                        } else {
                            html = obj({ text: EntScalearray[i].val, disabled: "disabled", checked: '' });
                        }
                    } else {
                        if (i == 0) {
                            html = obj({ text: EntScalearray[i].val, checked: "checked", disabled: '' });
                        } else {
                            html = obj({ text: EntScalearray[i].val, checked: "", disabled: '' });
                        }
                    }

                    $("#EntScalediv").append($(html));
                }
                form.render();
            }
            ///加载公司性质
            function loadEntNature(iscun) {
                $("#EntNaturediv").children().remove();
                for (var i = 0; i < EntNaturearray.length; i++) {
                    var obj = _.template($("#muban2").html());
                    var html = "";
                    if (iscun) {
                        if (EntNaturearray[i].val == objdata.EntNature) {
                            html = obj({ text: EntNaturearray[i].val, checked: "checked", disabled: '' });
                        } else {
                            html = obj({ text: EntNaturearray[i].val, disabled: "disabled", checked: '' });
                        }
                    } else {
                        if (i == 0) {
                            html = obj({ text: EntNaturearray[i].val, checked: "checked", disabled: '' });
                        } else {
                            html = obj({ text: EntNaturearray[i].val, checked: "", disabled: '' });
                        }
                    }

                    $("#EntNaturediv").append($(html));
                }
                form.render();
            }
            ///加载专业
            function loadsepclist(iscun) {
                console.log(sepclist);
                $("#Specialtydiv").children().remove();
                for (var i = 0; i < sepclist.length; i++) {
                    var obj = _.template($("#muban3").html());
                    var html = "";
                    if (iscun) {
                        html = obj({ text: sepclist[i].SpecialtyName, Id: sepclist[i].Id, disabled: "disabled", checked: '' });
                    } else {
                        if (i == 0) {
                            html = obj({ text: sepclist[i].SpecialtyName, Id: sepclist[i].Id, checked: "checked", disabled: '' });
                            jsenplist.push(sepclist[i].Id);
                        } else {
                            html = obj({ text: sepclist[i].SpecialtyName, Id: sepclist[i].Id, checked: "", disabled: '' });
                        }
                    }

                    $("#Specialtydiv").append($(html));
                }
                $('.duoduo').each(function (index) {
                    
                    if (yes) {
                        var entlist = objdata.entspee.split("-");
                        //console.log(entlist);
                        for (var i = 0; i < entlist.length; i++) {
                            //console.log($(this).val());
                            //console.log(entlist[i]);
                            if ($(this).val() == entlist[i]) {
                                console.log('join');
                                jsenplist.push($(this).val());
                                $(this).attr('checked', 'checked');
                            }
                        }
                    }

                });
                form.render();


            }
            ///加载公司地址
            function loadEntAddress(iscun) {
                $('#EntAddressDiv').children().remove();
                var obj = "";
                var html = "";
                if (iscun) {
                    obj = _.template($("#muban4").html());
                    html = obj({ text: objdata.EntAddress });
                } else {
                    obj = _.template($("#muban5").html());
                    html = obj({ text: "" });
                }
                $("#EntAddressDiv").append($(html));
                form.render();
            }
            form.on('checkbox(mycheckbox)', function (data) {
                if (data.elem.checked) {
                   jsenplist.push(data.value);
                } else {
                    for (var i = jsenplist.length - 1; i >= 0; i--) {
                        if (jsenplist[i] == data.value) {
                            jsenplist.splice(i,1);
                        }
                    }
                }
            }); 
            //提交
            form.on('submit(demo1)', function (data) {
                data.field.EntinfoID = entid;
               
                if (yes) {
                    data.field.EntSpee = objdata.entspee;
                } else {
                    var entspee="";
                    for (var i = 0; i < jsenplist.length; i++) {
                        entspee = entspee + jsenplist[i] + "-";
                    }
                    entspee = entspee.substring(0, entspee.length - 1);
                    data.field.EntSpee = entspee;
                }
                 console.log(data.field);
                $.ajax({
                    url: '/Obtainemployment/EmploySituation/employed',
                    //async: false,
                    type:'POST',
                    data: { param0: data.field },
                    success: function (successdata) {
                        if (successdata.Success) {
                            layer.msg('录入成功！', { icon: 6, time: 2000 }, function () {
                                close();
                            });

                        } else {
                            layer.msg(successdata.Msg, { icon: 6, time: 2000 }, function () {

                            });
                        }
                    },
                    error: function (errordata) {
                        layer.msg('网络不佳!', { icon: 6, time: 2000 }, function () {

                        });
                    }
                });
                return false;
            });
            $('#signout').click(function () {
                close();
            });
            function close() {
                //当你在iframe页面关闭自身时
                var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
                parent.layer.close(index); //再执行关闭
            }
        });
    </script>
</body>
</html>
