
@{
    ViewBag.Title = "ReconcileIndexViews";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@using SiliconValley.InformationSystem.Entity.MyEntity
@section style{
    <style>
        body .demo-class .layui-layer-title
        {
            background: #009688;
            color: #fff;
            border: none;
        }

        #but1
        {
            position: absolute;
            top: 13%;
            left: 35%;
            width: 36px;
            height: 36px;
            text-align: center;
            line-height: 36px;
        }

        #but1:hover
            {
                background-color: aqua;
            }

        #Nation
        {
            width: 100px;
        }

        .linu
        {
            width: 130px;
        }

        .mm
        {
            border: 1px solid black;
        }

        .LableCss1
        {
            text-overflow: ellipsis;
            white-space: nowrap;
            float: left;
            display: block;
            padding: 9px 15px;
            width: 80px;
            font-weight: 400;
            line-height: 20px;
            text-align: right
        }
                
        .layButCss1
        {
            display: inline-block;
            height: 38px;
            line-height: 38px;
            padding: 0 18px;
            background-color: #009688;
            color: #fff;
            white-space: nowrap;
            text-align: center;
            font-size: 14px;
            border: none;
            border-radius: 2px;
            cursor: pointer;
            border: 0px solid #C9C9C9;
            background-color: #fff;
            color: #555;
            height: 18px;
            line-height: 18px
        }

        .layui-unselect
        {
            width: 130px;
            border-radius: 5px;
        }

        /*.Back_Color
        {
            background-color: rgba(0,0,1,0);
        }*/
    </style>
}

<form class="layui-form" lay-filter="Reconcileindexform">
    <div class="layui-row layui-form-item">
        <div class="layui-col-xs2 layui-col-sm2 layui-col-md2">
            <label class="layui-form-label">阶&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;段:</label>
            <div class="layui-input-block">
                @Html.DropDownList("mygrand", ViewBag.grandlist as IEnumerable<SelectListItem>, new Dictionary<string, object>() { { "class", "linu" }, { "lay-filter", "grandselect" } })
            </div>
        </div>
        <div class="layui-col-xs2 layui-col-sm2 layui-col-md2">
            <label class="layui-form-label">班&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;级:</label>
            <div id="myclass" class="layui-input-block">

            </div>
        </div>
        <div class="layui-col-xs2 layui-col-sm2 layui-col-md2">
            <label class="layui-form-label">专&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;业:</label>
            <div id="marjon" class="layui-input-block">

            </div>
        </div>
        <div class="layui-col-xs3 layui-col-sm3 layui-col-md3">
            <label class="LableCss1">上课时间:</label>
            <div id="ClssTime" class="layui-input-block">
                <div class="layui-col-md3">
                    <input style="color:black" type="radio" name="time" id="time" value="上午" title="上午" disabled="disabled">
                </div>
                <div class="layui-col-md3">
                    <input style="color:black" type="radio" name="time" id="time" value="下午" title="下午" disabled="disabled">
                </div>
                
            </div>
        </div>
        <div class="layui-col-xs2 layui-col-sm2 layui-col-md2">
            <label class="layui-form-label">课&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;程:</label>
            <div id="currr_div" class="layui-input-block">

            </div>

        </div>
    </div>
    <div class="layui-row layui-form-item">

        <div class="layui-col-xs3 layui-col-sm3 layui-col-md3">
            <label class="LableCss1">日&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;期:</label>
            <div class="layui-input-block" id="div_time">

            </div>
        </div>
        <div class="layui-col-xs3 layui-col-sm3 layui-col-md3">
            <label class="LableCss1">校&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;区:</label>
            <div class="layui-input-block" id="div_time">
                @Html.DropDownList("schoolAddress", ViewBag.Schooladdress as List<SelectListItem>, new Dictionary<string, object>() { { "class", "linu" }, { "lay-filter", "schooladdress" } })
            </div>
        </div>
        <div class="layui-col-xs3 layui-col-sm3 layui-col-md3">
            <label class="layui-form-label">教&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;室:</label>
            <div id="classroom_div" class="layui-input-block">

            </div>
        </div>
        <div class="layui-col-xs3 layui-col-sm3 layui-col-md3">
            <label class="LableCss1">老&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;师:</label>
            <div id="teacher_div" class="layui-input-block">

            </div>
        </div>        
    </div>
    <div class="layui-row layui-form-item">
        <div style="text-align:right;width:91%;">            
                <input id="Anan" type="submit"  class="layui-btn" lay-submit="" lay-filter="Anpai" value="系统排课" />
                <input id="Anan1" type="button" class="layui-btn" value="手动排课" onclick="OpenNanualView()" />
                <input id="Anan2" type="button" class="layui-btn" value="其他课程排课" onclick="OrtherView()" style="width:120px;margin-right:10px" />                 
                       
        </div>
    </div>
    <fieldset>
        <legend>排课显示</legend>
        <div id="Reconcile_div">
            <table lay-filter="Reconcile_table" id="Reconcile_table"></table>
        </div>        
    </fieldset>
</form>
@section script{
<script src="~/Scripts/Tangmin_CssAndJs/com_js/MyOrther_tangmin.js"></script>
    <script>           
        function TableFulsh() {
            layui.use('table', function () {
                var table = layui.table;
                table.reload('Reconcile_table');
            });
        }

        layui.use(['form', 'laydate', 'table'], function () {
            var form = layui.form;
            var laydate = layui.laydate;
            var table = layui.table;
            //获取班级
            form.on('select(grandselect)', function (data) {              
                //清空班级DIV
                $("#myclass")[0].innerHTML = "";
                //清空课程DIV
                $("#currr_div")[0].innerHTML = "";
                //清空专业DIV
                $("#marjon")[0].innerHTML = "";
                //清空教室DIV
                $("#classroom_div")[0].innerHTML = "";
                //清空教员DIV
                $("#teacher_div")[0].innerHTML = "";
                form.val("Reconcileindexform", { "schoolAddress": "0" });   //将下拉框改为初始值
                if (data.value != "0") {
                    $.ajax({
                        url: '/Educational/Reconcile/GetClassScheduleSelect/' + data.value,
                        success: function (sudata) {
                            //获取班级slect
                            var classselect = $('<select id="class_select" name="class_select" class="layui-select" lay-filter="bianji"><option value="0" selected>--请选择--</select>');
                            for (var i = 0; i < sudata.length; i++) {
                                $('<option value=' + sudata[i].id + '>' + sudata[i].ClassNumber + '<option>').appendTo(classselect);
                            }
                            $("#myclass").append(classselect);
                            form.render(); //更新全部
                        }
                    });
                }                 
            });      
            //获取课程
            form.on('select(bianji)', function (data) {
                $("#currr_div")[0].innerHTML = "";
                $("#marjon")[0].innerHTML = "";
                //清空日期
                $("#div_time")[0].innerHTML = "";  
                $('<input type="text" name="startTime" id="startTime" class="layui-input linu" />').appendTo($("#div_time"));
                //日期
                laydate.render({
                    elem: '#startTime',
                    done: function (value) {
                        var dd = new Date(value);
                        if (dd.getMonth() >= 6 && dd.getMonth() <= 9 && judgeDate(value) == "周日") {
                            layer.msg('排课日期不能是周日', { icon: 2 }, function () {
                                  //清空教师跟任课老师
                                $("#classroom_div")[0].innerHTML = "";
                                $("#teacher_div")[0].innerHTML = "";
                            });
                           
                        } else {
                            if (judgeDate(value) == "周日" || judgeDate(value) == "周六") {
                                layer.msg('排课日期不能是周日或周六', { icon: 2 }, function () {
                                    $("#classroom_div")[0].innerHTML = "";
                                    $("#teacher_div")[0].innerHTML = "";
                                });
                            } else {
                                //获取上课时间段
                                var timeName = $($("#ClssTime :checked")[0]).val();
                                var Time = value;
                                var Getdata = { "Time": Time, "Curr": $("#kecheng").val(), "timeName": timeName };
                                $("#classroom_div")[0].innerHTML = "";
                                $("#teacher_div")[0].innerHTML = "";
                                if (value.length > 0) {                                    
                                    //获取任课老师
                                    $.ajax({
                                        url: '/Educational/Reconcile/GetTeacher',
                                        type: 'POST',
                                        data: Getdata,
                                        success: function (suc) {
                                            var teachersele = $('<select id="teachersele" name="teachersele" class="SelectTeacherCss1"><option value="0">--请选择--</select>');
                                            for (var i = 0; i < suc.length; i++) {
                                                $('<option value=' + suc[i].Value + '>' + suc[i].Text + '</option>').appendTo(teachersele);
                                            }
                                            $("#teacher_div").append(teachersele);
                                            form.render(); //更新全部
                                        }
                                    });
                                } else {
                                    $("#classroom_div")[0].innerHTML = "";
                                    $("#teacher_div")[0].innerHTML = "";
                                }

                            }
                             
                        }
                         
                    }
                });
                if (data.value != "0") {
                    $.ajax({
                        url: '/Educational/Reconcile/GetClassDate/' + data.value,
                        success: function (sucdata) {
                            if (sucdata.stataus == "true") {
                                $('<input  type="text" disabled="disabled"  class="layui-input linu" value=' + sucdata.classData.marjoiName+'>').appendTo($("#marjon"));//加载专业数据
                                var myselect_c = $("<select name='kecheng' id='kecheng'></select>");
                                for (var i = 0; i < sucdata.c_list.length; i++) {
                                    $("<option value=" + sucdata.c_list[i].CurriculumID + ">" + sucdata.c_list[i].CourseName + "<option>").appendTo(myselect_c);
                                }
                                $("#currr_div").append(myselect_c);
                                //上课时间
                                $(":radio").each(function (index, ele) {
                                    if (ele.value == sucdata.classData.ClassDate) {
                                        ele.checked = "checked";
                                        $(ele).removeAttr("disabled");
                                    } else {
                                        $(ele).attr("disabled", "disabled");
                                    }
                                });
                                form.render(); //更新全部
                            } else {
                                layer.msg('班级名称错误！！！', { icon: 2 });
                            }

                        }
                    });
                    //表格重载
                    table.reload('Reconcile_table', {
                        url: '/Educational/Reconcile/GetTableData',
                        where: { "classname": data.value } //设定异步数据接口的额外参数
                    });
                } else {
                    //清空日期
                    $("#div_time")[0].innerHTML = "";
                    //清空课程DIV
                    $("#currr_div")[0].innerHTML = "";
                    //清空专业DIV
                    $("#marjon")[0].innerHTML = "";
                    //清空教室DIV
                    $("#classroom_div")[0].innerHTML = "";
                    //清空教员DIV
                    $("#teacher_div")[0].innerHTML = "";
                }                  
            });
            //根据校区获取空教室
            form.on('select(schooladdress)', function (data) {               
                var timenameval = $("input:checked").val();  //获取上课的时间                
                var dateval = $("#startTime").val(); //获取日期                
                var schooldaddressval = data.value; //获取校区
                var MY = { "timenameval": timenameval, "dateval": dateval, "schooldaddressval": schooldaddressval};
                if (dateval.length <= 0) {
                    layer.msg('请先选择排课日期!!!', { icon: 2 });
                  
                    form.val("Reconcileindexform", { "schoolAddress": "0" });   //将下拉框改为初始值
                } else if (schooldaddressval == "0") {
                    layer.msg('请先有效的校区!!!', { icon: 2 });
                } else {
                    $("#classroom_div")[0].innerHTML = "";
                    //加载教室               
                    $.ajax({
                        url: '/Educational/Reconcile/GetSchoolEmptyRoom',
                        type: 'POST',
                        data: MY,
                        success: function (suc) {                          
                            var classroom = $('<select id="myclassroom" name="myclassroom"></select>');
                            for (var i = 0; i < suc.Data.length; i++) {
                                $('<option value=' + suc.Data[i].Id + '>' + suc.Data[i].ClassroomName + '</option>').appendTo(classroom);
                            }
                            $("#classroom_div").append(classroom);
                            form.render(); //更新全部
                        }

                    })
                }
                 
            });
            //table加载
            table.render({
                elem: '#Reconcile_table'
                , url:'/Educational/Reconcile/GetTableData'
                , cols: [[
                     { field: 'classname', title: '班级', fixed: 'left' }
                    , { field: 'classroom', title: '教室', }
                    , { field: 'curriName', title: '课程' }
                    , { field: 'Sketime', title: '上课时间段' }
                    , { field:'Teacher',title:'任课老师'}
                    , {
                        field: 'ADate', title: '日期', templet: function (res) {
                            return TimeChange(res.ADate);
                        }
                    }
                ]]
                , page: true
            });
             
             //排课
            form.on('submit(Anpai)', function (data) {
                var mydata = data.field;
                if (mydata.class_select == "0") {
                    layer.msg('请选择有效的班级！！！', { icon: 2 });
                } else if (mydata.startTime == "") {
                    layer.msg('请选择排课日期！！！', { icon: 2 });
                } else if (mydata.myclassroom == undefined || mydata.myclassroom == 0) {
                    layer.msg('请选择教室！！！', { icon: 2 });
                } else if (mydata.teachersele == "0" || mydata.teachersele == undefined) {
                    
                    layer.msg('请选择任课老师！！！', { icon: 2 });
                } else {
                    var myindexof = layer.load(1);
                    $.ajax({
                        url: '/Educational/Reconcile/PaikeFunction',
                        type: 'POST',
                        data: mydata,
                        success: function (Sucdata) {                            
                            if (Sucdata.Success == true) {
                                layer.close(myindexof); 
                                layer.msg(Sucdata.Msg, { icon: 1,shade:0.8 }, function () {
                                    table.reload('Reconcile_table', {
                                        url: '/Educational/Reconcile/GetTableData',
                                        where: { "classname": mydata.class_select }  
                                    });
                                });
                            } else {
                                layer.close(myindexof); 
                                layer.msg(Sucdata.Msg, { icon: 2 }, function () {
                                    table.reload('Reconcile_table', {
                                        url: '/Educational/Reconcile/GetTableData',
                                        where: { "classname": mydata.class_select }  
                                    });
                                });
                            }
                        }
                    });
                }
                return false;
            });
        });
        //打开手动排课页面
        function OpenNanualView() {
            var layer = layui.layer;
            layer.open({
                type: 2,
                content: '/Educational/Reconcile/ManualReconcileView'  
                , area: ['1000px', '500px'],
                title: '手动排课'
                , shade: 0.8
                , anim: 4
                , skin: 'demo-class'
            });
        }
        //打开非专业课排课页面
        function OrtherView() {
            var layer = layui.layer;
            layer.open({
                type: 2,
                content: '/Educational/Reconcile/AnpaiNotMarginView'
                , area: ['800px', '700px'],
                title: '其他课程排课页面'
                , shade: 0.8
                , anim: 4
                , skin: 'demo-class'
            });
        }

        $(function () {
            layui.use(['form'], function () {
                var form = layui.form;
                form.val("Reconcileindexform", { "schoolAddress": "0" });   //将下拉框改为初始值
            });
        });
    </script>
}

