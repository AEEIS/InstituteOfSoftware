
@{
    ViewBag.Title = "StockInfoIndexView";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@section style{
    <style>
        #left_div{
        border:0px solid black;
        width:15%;
        float:left;
        }
        #right_div
        {
            border: 0px solid black;
            width: 83%;
            float: right;
        }
        body .demo-class .layui-layer-title
        {
            background: #009688;
            color: #fff;
            border: none;
        }
    </style>
}
    <div id="master_div">
        <div>
            <hr />
            <label>物品名称：</label>
            <div class="btn-group layui-container" style="width:120px;">
                <div style="display:inline-block">
                    <input type="text" class="form-control" id="GoodsName" name="GoodsName" placeholder="物品名称">
                </div>
            </div>
            <button id="serchBtn1" class="layui-btn layui-btn-radius layui-btn-primary" onclick="SERCHER()">查询</button>
            <hr />
        </div>
        <div id="left_div">
            @*物品类型*@
            <ul id="GoodsType_Tree"></ul>
        </div>
        <div id="right_div">
            @*物品库存*@
            <table id="Stockinfo_table" lay-filter="Stockinfo_table"> </table>


            <script type="text/html" id="StockinfobarDemo">
                <a class="layui-btn layui-btn-xs" lay-event="edit">查看详情</a>
            </script>
           
        </div>
    </div>

@section script{
    <script>
        //按钮查询
          function SERCHER() {
              layui.use(['table'], function () {
                  var table = layui.table;
                  table.reload('Stockinfo_table', {
                      url: '/Educational/StockInfo/GetStockInfo_data'
                      , where: { "GoodsName": $("#GoodsName").val(),"id":"0" } //设定异步数据接口的额外参数
                  });
              });
          }
          $(function () {
            layui.use(['tree', 'layer','table'], function () {
                var tree = layui.tree;
                var layer = layui.layer;
                var table = layui.table;
                //编辑或添加方法
                function AddorEdit(mydata,myurl) {
                    $.ajax({
                        url: myurl,
                        type: 'POST',
                        data: mydata,
                        success: function (SucData) {
                            if (SucData == "ok") {
                                $.ajax({
                                    url: "/Educational/StockInfo/LoadTree_GoodsTypeData",
                                    success: function (Successdata) {
                                        Tree(Successdata);
                                    }
                                });
                            } else {
                                layer.msg(SucData, { icon: 2 }, function () {
                                    $.ajax({
                                        url: "/Educational/StockInfo/LoadTree_GoodsTypeData",
                                        success: function (Successdata) {
                                            Tree(Successdata);
                                        }
                                    });
                                })
                            }
                        }
                    });
                }
                //渲染
                function Tree(Successdata) {                 
                    tree.render({
                        elem: '#GoodsType_Tree',
                        data: [{
                            title: '物品类型',
                            id: "0",
                            spread: true,
                            children: Successdata
                        }] 
                        , edit: ['add', 'update'] //操作节点的图标
                        
                        ,click: function (obj) {
                            var id = obj.data.id;                             
                            table.reload('Stockinfo_table', {
                                url: '/Educational/StockInfo/GetStockInfo_data'
                                , where: { "id": id,"GoodsName":""} //设定异步数据接口的额外参数
                            });
                        }
                        ,   operate: function (obj) {
                            var type = obj.type; //得到操作类型：add、edit、del
                            var data = obj.data; //得到当前节点的数据
                            var elem = obj.elem; //得到当前节点元素

                            //Ajax 操作
                            //var id = data.id; //得到节点索引
                            if (type === 'add') { //增加节点  
                                //var farther_id = data.id;
                                var mydata = { "Id": data.id,"Tiaojian":"true"}
                                AddorEdit(mydata, '/Educational/StockInfo/AddorEdit');
                            } else if (type === 'update') { //修改节点                              
                                var editvalue = elem.find('.layui-tree-txt').html(); //得到修改后的内容    
                                var mydata = { "Id": data.id, "Tiaojian": "false", "Name": editvalue }
                                if (data.id == 0) {
                                    layer.msg('该名称不能修改', { icon: 2 }, function () {
                                        $.ajax({
                                            url: "/Educational/StockInfo/LoadTree_GoodsTypeData",
                                            success: function (Successdata) {
                                                Tree(Successdata);
                                            },
                                            error: function () {
                                                layer.msg('加载数据有误，请重试', {
                                                    icon: 2,
                                                    time: 2000 //2秒关闭（如果不配置，默认是3秒）
                                                });
                                            }
                                        });
                                    });
                                } else {
                                    layer.confirm('确定修改?', { icon: 3, title: '提示' }, function (index) {

                                        if (editvalue.length <= 0) {
                                            layer.msg('修改之后的值不能为空！！！', { icon: 2 }, function () {
                                                $.ajax({
                                                    url: "/Educational/StockInfo/LoadTree_GoodsTypeData",
                                                    success: function (Successdata) {
                                                        Tree(Successdata);
                                                    }
                                                });
                                            })
                                        } else {
                                            AddorEdit(mydata, '/Educational/StockInfo/AddorEdit');
                                        }
                                        layer.close(index);
                                    });
                                }
                                 
                                
                            } 
                        }
                    });
                }
               
         
                $.ajax({
                url: "/Educational/StockInfo/LoadTree_GoodsTypeData",
                success: function (Successdata) {
                    Tree(Successdata);
                },
                error: function () {
                    layer.msg('加载数据有误，请重试', {
                        icon: 2,
                        time: 2000 //2秒关闭（如果不配置，默认是3秒）
                    });
                }
            });

                table.render({
                    elem: '#Stockinfo_table'
                    , url: '/Educational/StockInfo/GetStockInfo_data'
                    , cols: [[
                        { type: 'radio', fixed: 'left' }
                        , { field: 'GoodsName', title: '物品名称', fixed: 'left', unresize: true}
                        , { field: 'GoodsTypeName', title: '物品类型'  }
                        , {field: 'stockcount', title: '库存数量' ,width:100 }
                        , { field: 'Address', title: '存放地点',  }
                        , { field: 'Rmark', title: '说明'}
                        , {
                            field: 'IsDel', title: '系统提示', width: 150, templet: function (res) {
                                if (res.stockcount >= 10) {
                                    return '<span>数量充足</span>';
                                } else {
                                    return '<span style="color:red">该物品快用完了</span>';
                                }

                            }
                        }
                        , { fixed: 'right', title: '操作', toolbar: '#StockinfobarDemo', width: 100 }
                    ]]
                    , page: true
                });

                
            });
        });
    </script>
}

