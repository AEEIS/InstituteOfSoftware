
@{
    Layout = null;
}

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>ExcleIntoView</title>
    <link href="~/Scripts/layui/css/layui.css" rel="stylesheet" />
    <style>
        .fieldsetCssTwo1 {
            margin-top: 20px;
            border: 1px solid #009688;
        }
        .legendCssTwo1 {
            border: 1px solid #009688;
            background-color:#009688;
            color:#fff;
        }
        .divCssTwo1{           
            float:right;
            display:inline-block;
            margin-top:20px;
        }
    </style>
</head>
<body>
    <div>
        <form action="/Market/StudentDataKeep/IntoFunction" method="post" enctype="multipart/form-data">
            <fieldset class="fieldsetCssTwo1">
                <legend class="legendCssTwo1">文件选择区</legend>
                <button type="button" class="layui-btn" id="test3"><i class="layui-icon"></i>选择Excel文件</button>
            </fieldset>
            <fieldset class="fieldsetCssTwo1" style="height:420px;">
                <legend class="legendCssTwo1">文件内容显示区</legend>
                <table id="tabletest2" lay-filter="tabletest2"></table>
            </fieldset>
            <div class="divCssTwo1">
                <button class="layui-btn" id="Yes" name="Yes">确定导入</button>
                <button class="layui-btn" id="No" name="No">取消</button>
            </div>
        </form>
    </div>
    <script src="~/Scripts/jquery-3.3.1.min.js"></script>
    <script src="~/Scripts/layui/layui.js"></script>
    <script>
        //转换时间的方法
        function TimeChange(newtime) {
            if (newtime == null)
                return "";
            var date = new Date(parseInt(newtime.slice(6)));
            var year = date.getFullYear();
            var month = date.getMonth();
            if (month < 10) {
                month = "0" + Number(month + 1);
            }
            var day = date.getDate();
            if (day < 10) {
                day = "0" + day;
            }
            var result = year + '-' + month + '-' + day;
            return result;
        }
        //导入Excel
        $("#Yes").click(function () {
            $.ajax({
                url: '/Market/StudentDataKeep/IntoServer',
                success: function (successData) {
                    console.log(successData);
                    if (successData.msg == "ok") {
                        if (successData.data.length == 0) {
                            layui.use('layer', function () {
                                var layer = layui.layer;
                                layer.msg("成功导入!", {
                                    icon: 1,
                                    time: 2000 //2秒关闭（如果不配置，默认是3秒）
                                }, function () {
                                    var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
                                    parent.layer.close(index); //再执行关闭   
                                    window.parent.LoadTable();
                                });
                            });
                        } else {
                            var str = "一共有" + successData.data.length + "条数据冲突，冲突的学员姓名有:";
                            for (var i = 0; i < successData.data.length; i++) {
                                str = str + successData.data[i].StuName+",";
                            }
                         
                            //示范一个公告层
                            layer.open({
                                type: 1
                                , title: false //不显示标题栏
                                , closeBtn: false
                                , area: '300px;'
                                , shade: 0.8
                                , id: 'LAY_layuipro' //设定一个id，防止重复弹出
                                , btn: ['OK']
                                , btnAlign: 'c'
                                , moveType: 1 //拖拽模式，0或者1
                                , content: '<div style="padding: 50px; line-height: 22px; background-color: #393D49; color: #fff; font-weight: 300;">亲爱的操作人员！<br>layer ≠ layui<br><br>没有重复的数据已经成功导入到平台<br><br>以下是我们检测出有冲突的数据，请前往平台查看<br><br>' + str+' ^_^</div>'
                                 
                            });
                        }
                    }                   
                    else {
                        layui.use('layer', function () {
                            var layer = layui.layer;
                            layer.msg("导入失败!请重试", {
                                icon: 1,
                                time: 2000 //2秒关闭（如果不配置，默认是3秒）
                            }, function () {                   
                            });
                        });
                    }
                }
            });
        });
        //取消
        $("#No").click(function () {
            var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
            parent.layer.close(index); //再执行关闭   
        });
        layui.use(['upload','table'], function () {
            var $ = layui.jquery
                , upload = layui.upload;
             table = layui.table;
             layer = layui.layer;
            //指定允许上传的文件类型
            upload.render({
                elem: '#test3'
                , url: '/Market/StudentDataKeep/IntoFunction'
                , accept: 'file' //普通文件
                , exts: 'xls|xlsx'//只允许上传Excle文件
                , done: function (res) {
                    if (res.msg == "ok") {
                        table.render({
                            elem: '#tabletest2'
                            , data:res.data
                            , cellMinWidth: 60 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
                            , cols: [[
                                { type: 'checkbox', fixed: 'left' }
                                , { field: 'StuName', title: '姓名' }
                                , {
                                    field: 'StuSex', title: '性别', templet: function (res) {
                                        if (res.StuSex == false) {
                                            return "女";
                                        } else {
                                            return "男";
                                        }
                                    }
                                }
                                , { field: 'StuPhone', title: '联系电话' }
                                , { field: 'StuEducational', title: '学历' }
                                , { field: 'StuQQ', title: 'QQ' }
                                , { field: 'StuSchoolName', title: '学校' }
                                , { field: 'StuWeiXin', title: '微信' }
                                , { field: 'StuInfomationType_Id', title: '信息来源' }
                                , { field: 'EmployeesInfo_Id', title: '备案人' }
                                , { field: 'Reak', title: '说明' }
                            ]]
                            , page: true
                            , limits: [5, 8]
                            , limit: 5
                        });
                    } else if (res == "文件格式错误") {
                        layer.msg("Excle文件格式错误!请看Excel导入格式文档在操作!", {
                            icon: 1,
                            time: 2000 //2秒关闭（如果不配置，默认是3秒）
                        }, function () {
                        });
                    } else if (res == "no") {
                        layer.msg("操作错误!", {
                            icon: 1,
                            time: 2000 //2秒关闭（如果不配置，默认是3秒）
                        }, function () {
                        });
                    }
                }
            });               
        });
    </script>
</body>
</html>
