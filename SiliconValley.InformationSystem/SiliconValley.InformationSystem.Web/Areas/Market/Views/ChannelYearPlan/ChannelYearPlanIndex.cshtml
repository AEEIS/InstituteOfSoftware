
@{
    ViewBag.Title = "ChannelYearPlanIndex";
    Layout = "~/Views/Shared/_Layout.cshtml";
}


<style>
    .mylab {
     width: 86px;
    }
   
</style>

<script src="~/Scripts/underscore.js"></script>
<form class="layui-form">
    <div class="layui-form-item">
        <label class="layui-form-label mylab" >选择年度</label>
        <div class="layui-input-inline" style="  width: 157px;">
            <select name="interest" lay-filter="plan">
                @{
                    foreach (var item in ViewBag.YearName)
                    {
                        <option value="@item.SchoolPlanID">@item.ShowTitle</option>
                    }
                }

        
            </select>
        </div>
        <label class="layui-form-label mylab">选择主任</label>
        <div class="layui-input-inline " style="  width: 157px;">
            <select name="interest" lay-filter="zhuren" id="select">
            
            </select>
        </div>
        <label class="layui-form-label mylab">专员名字</label>
        <div class="layui-input-inline">
            <input type="text" name="" placeholder="专员名字。" autocomplete="off" class="layui-input">
        </div>
        <button class="layui-btn layui-btn-radius layui-btn-primary" lay-submit lay-filter="*">搜索</button>
    </div>


</form>

<table class="layui-hide" id="channelstaff" lay-filter="channelstafffilter"></table>
<div></div>
<script type="text/html" id="barDemo">
    <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="distribution">分配区域</a>
</script>

<script type="text/template" id="muban">
    <option value="{{=EmployeeId}}">{{=EmpName}}</option>
</script>

@section script{
    <script>



        layui.use(['table', 'layer'], function () {
            var table = layui.table, layer = layui.layer; //layui对象
            var mrdplanID, mrdempid, tableIns;
            MrDLayer = layer;
            $(function () {
                mrdplanID =@Html.Raw(ViewBag.NowYearName.SchoolPlanID);
                loadtable();
            });
            //时间转换方法
            function TimeChange(newtime) {
                if (newtime == null)
                    return "";
                var date = new Date(parseInt(newtime.slice(6)));
                var year = date.getFullYear();
                var month = date.getMonth();
                if (month < 10) {
                    month = "0" + Number(month + 1);
                }
                var day = date.getDate();
                if (day < 10) {
                    day = "0" + day;
                }
                var result = year + '-' + month + '-' + day;
                return result;
            }

            ///加载主任下拉框
            function loadselect(planid) {
                $.ajax({
                    url: '/Market/ChannelYearPlan/LoadZhuren',
                    data: { Plan: planid },
                    async: true,
                    success: function (data) {
                        $("#select").children().remove();
                        var mrdcompiled = _.template($("#muban").html());
                        var mrdhtml = mrdcompiled({ EmpName: '主任团队', EmployeeId: '0' });
                        $("#select").append($(mrdhtml));
                        for (var i = 0; i < data.length; i++) {
                            var compiled = _.template($("#muban").html());
                            var html = compiled({ EmpName: data[i].EmpName, EmployeeId: data[i].EmployeeId });
                            $("#select").append($(html));
                        }
                    },
                    error: function (data) {

                    }
                });
            };
            function loadtable() {
                   //展示已知数据
             tableIns = table.render({
                elem: '#channelstaff'
                , url: '/Market/ChannelYearPlan/ChannelYearPlanData?param0='+mrdplanID //数据接口
                , page: true //开启分页
                , even: true //开启隔行背景
                , limit: 15
                , limits: [15, 30, 45, 60, 75]
                , cols: [[ //标题栏
                    , { type: 'checkbox' }
                    , { field: 'EmpStaffID', title: '员工编号', width: 80, sort: true, hide: true }
                    , { field: 'ChannelStaffID', title: '渠道员工id', width: 165, hide: true }
                    , { field: 'ChannelYearPlanID', title: '年度计划id', width: 165, hide: true }
                    , { field: 'EmpName', title: '员工姓名', width: 89 }
                    , { field: 'Phone', title: '联系方式', width: 140 }
                    , { field: 'Region', title: '带领区域', width: 100 }
                    , { field: 'RegionID', title: '区域id', width: 89, hide: true }
                    , { field: 'BeianNumber', title: '备案数量', width: 89 }
                    , { field: 'GoSchoolNumber', title: '上门数量', width: 89 }
                    , { field: 'SignUpNumber', title: '报名数量', width: 89 }
                    , { field: 'PlanNumber', title: '区域量', width: 89 }
                    , { field: 'DebitNumber', title: '借资次数', width: 89 }
                    , {
                        field: 'ChannelDate', title: '入职时间', width: 135, templet: function (v) {
                            return TimeChange(v.ChannelDate);
                        }
                    }
                    , {
                        field: 'QuitDate', title: '离职时间', width: 135, templet: function (v) {
                            return TimeChange(v.QuitDate);
                        }
                    }
                    , { field: 'Remark', title: '备注', width: 165 }
                    , { fixed: 'right', title: '操作', width: 80, align: 'center', toolbar: '#barDemo' }
                ]]

            });
            }
         
                      //显示条件查询
            function WhyShow(planid, empid) {

                tableIns.reload({
                    where: {
                        PlanID: planid,
                        EmpID: empid
                    }
                    , page: {
                        curr: 1
                    }
                });
                loadselect(planid);
            };
            $("#grandlist li a").click(function () {
                var grand = $(this).text();
                $("#selectGrand")[0].innerHTML = grand + " <span class='caret'></span>";
                mrdplanID = $(this).attr("planid");
                WhyShow(mrdplanID, mrdempid);
            });
            $(document).off("click", "#Zhurenlist li").on('click', '#Zhurenlist li', function () {
                var dudu = $(this).text();
                $("#selectZhuren")[0].innerHTML = dudu + " <span class='caret'></span>";

                mrdempid = $($(this)[0].firstChild).attr('ZhurenID');
                WhyShow(mrdplanID, mrdempid);
            });
            $("#SearchEnter").click(function () {
                WhyShow();
            });

        });

    </script>
}
